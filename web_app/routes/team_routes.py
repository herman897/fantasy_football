from flask import Flask, request, render_template, Blueprint
from app.team import fetch_team_info, fetch_player_games
from app.ff import fetch_ff_json
from time import time
import datetime
import json

POSITION_LONG_NAMES = {
    "QB": "Quarterback",
    "RB1": "Running Back 1",
    "RB2": "Running Back 2",
    "WR1": "Wide Receiver 1",
    "WR2": "Wide Receiver 2",
    "TE": "Tight End",
    "FLEX": "Flex"
}

# Define the Blueprint
team_routes = Blueprint("team_route", __name__)

# Team Form Route
@team_routes.route("/team/form")
def team_form():
    print("TEAM INPUT...")
    return render_template("team_form.html")  # Render the input form

# Team View Route
@team_routes.route("/team/view", methods=["GET", "POST"])
def team_view():
    print("TEAM VIEW...")
    try:
        week = request.form.get('week', 1)
        projections: dict = fetch_ff_json(week).get("playerProjections")

        # Fetch player details for each input position
        fantasy_team = {}

        times = []

        # for position in POSITION_LONG_NAMES.keys():
        #     start = time()
        #     player = request.form.get(position)
        #     print(player)
        #     team_info = fetch_team_info(player)
        #     fantasy_team[POSITION_LONG_NAMES.get(position)] = team_info
        #     fantasy_team[POSITION_LONG_NAMES.get(position)]['projections'] = projections.get(team_info['playerID'], {})
        #     times.append(time() - start)

        # print(times)
        # print(sum(times) / len(times))
        fantasy_team = {'Quarterback': {'espnID': '3139477', 'espnName': 'Patrick Mahomes', 'sleeperBotID': '4046', 'fantasyProsPlayerID': '16413', 'espnIDFull': '3139477/patrick-mahomes', 'fRefID': 'MahoPa00', 'weight': '225', 'jerseyNum': '15', 'cbsShortName': 'P. Mahomes', 'team': 'KC', 'yahooPlayerID': '30123', 'age': '29', 'espnLink': 'https://www.espn.com/nfl/player/_/id/3139477/patrick-mahomes', 'yahooLink': 'https://sports.yahoo.com/nfl/players/30123', 'bDay': '9/17/1995', 'espnHeadshot': 'https://a.espncdn.com/i/headshots/nfl/players/full/3139477.png', 'isFreeAgent': 'False', 'rotoWirePlayerIDFull': 'patrick-mahomes-11839', 'cbsLongName': 'Patrick Mahomes', 'injury': {'injReturnDate': '20241221', 'description': 'Dec 16: Mahomes (ankle) has been diagnosed Monday with a "mild" right high-ankle sprain and is considered week-to-week, Ian Rapoport of NFL Network reports.', 'injDate': '', 'designation': 'Questionable'}, 'teamID': '16', 'pos': 'QB', 'school': 'Texas Tech', 'cbsPlayerID': '2142052', 'longName': 'Patrick Mahomes', 'rotoWirePlayerID': '11839', 'height': '6\'2"', 'cbsPlayerIDFull': '2142052/patrick-mahomes', 'lastGamePlayed': '20241215_KC@CLE', 'playerID': '3139477', 'exp': '8', 'fantasyProsLink': 'https://www.fantasypros.com/nfl/players/patrick-mahomes.php', 'stats': {'Rushing': {'rushYds': '262.0', 'carries': '52.0', 'rushTD': '1.0'}, 'Passing': {'passAttempts': '502.0', 'passTD': '22.0', 'passYds': '3348.0', 'int': '11.0', 'passCompletions': '335.0'}, 'Receiving': {'receptions': '1.0', 'recTD': '0.0', 'targets': '1.0', 'recYds': '2.0'}, 'gamesPlayed': '14', 'Defense': {'totalTackles': '0.0', 'fumblesLost': '0.0', 'defTD': '0.0', 'fumbles': '2.0', 'fumblesRecovered': '1.0', 'soloTackles': '0.0', 'defensiveInterceptions': '0.0', 'qbHits': '0.0', 'tfl': '0.0', 'passDeflections': '0.0', 'sacks': '0.0'}, 'teamID': '16', 'team': 'KC', 'teamAbv': 'KC'}, 'projections': {'twoPointConversion': '0.1', 'Rushing': {'rushYds': '22.0', 'carries': '4.1', 'rushTD': '0.1'}, 'Passing': {'passAttempts': '35.4', 'passTD': '2.1', 'passYds': '274', 'int': '0.7', 'passCompletions': '24.6'}, 'Receiving': {'receptions': '0', 'recTD': '0', 'targets': '0', 'recYds': '0'}, 'fumblesLost': '0.2', 'pos': 'QB', 'teamID': '16', 'team': 'KC', 'longName': 'Patrick Mahomes', 'playerID': '3139477', 'fantasyPointsDefault': {'standard': '21.46', 'PPR': '21.46', 'halfPPR': '21.46'}}, 'games': {}}, 'Running Back 1': {'espnID': '3043078', 'espnName': 'Derrick Henry', 'sleeperBotID': '3198', 'fantasyProsPlayerID': '15514', 'espnIDFull': '3043078/derrick-henry', 'fRefID': 'HenrDe00', 'weight': '247', 'jerseyNum': '22', 'cbsShortName': 'D. Henry', 'team': 'BAL', 'yahooPlayerID': '29279', 'age': '30', 'espnLink': 'https://www.espn.com/nfl/player/_/id/3043078/derrick-henry', 'yahooLink': 'https://sports.yahoo.com/nfl/players/29279', 'bDay': '1/4/1994', 'espnHeadshot': 'https://a.espncdn.com/i/headshots/nfl/players/full/3043078.png', 'isFreeAgent': 'False', 'rotoWirePlayerIDFull': 'derrick-henry-10819', 'cbsLongName': 'Derrick Henry', 'injury': {'injReturnDate': '', 'description': '', 'injDate': '', 'designation': ''}, 'teamID': '3', 'pos': 'RB', 'school': 'Alabama', 'cbsPlayerID': '2061188', 'longName': 'Derrick Henry', 'rotoWirePlayerID': '10819', 'height': '6\'2"', 'cbsPlayerIDFull': '2061188/derrick-henry', 'lastGamePlayed': '20241215_BAL@NYG', 'playerID': '3043078', 'exp': '9', 'fantasyProsLink': 'https://www.fantasypros.com/nfl/players/derrick-henry.php', 'stats': {'Rushing': {'rushYds': '1474.0', 'carries': '254.0', 'rushTD': '13.0'}, 'Receiving': {'receptions': '13.0', 'recTD': '2.0', 'targets': '15.0', 'recYds': '125.0'}, 'gamesPlayed': '14', 'Defense': {'totalTackles': '0.0', 'fumblesLost': '1.0', 'defTD': '0.0', 'fumbles': '3.0', 'fumblesRecovered': '0.0', 'soloTackles': '0.0', 'defensiveInterceptions': '0.0', 'qbHits': '0.0', 'tfl': '0.0', 'passDeflections': '0.0', 'sacks': '0.0'}, 'teamID': '3', 'team': 'BAL', 'teamAbv': 'BAL'}, 'projections': {'twoPointConversion': '0.1', 'Rushing': {'rushYds': '71.4', 'carries': '15.5', 'rushTD': '0.7'}, 'Passing': {'passAttempts': '0', 'passTD': '0', 'passYds': '0', 'int': '0', 'passCompletions': '0'}, 'Receiving': {'receptions': '1.1', 'recTD': '0.1', 'targets': '1.5', 'recYds': '8.2'}, 'fumblesLost': '0.1', 'pos': 'RB', 'teamID': '3', 'team': 'BAL', 'longName': 'Derrick Henry', 'playerID': '3043078', 'fantasyPointsDefault': {'standard': '12.86', 'PPR': '13.96', 'halfPPR': '13.41'}}, 'games': {}}, 'Running Back 2': {'espnID': '3128720', 'espnName': 'Nick Chubb', 'sleeperBotID': '4988', 'fantasyProsPlayerID': '17246', 'espnIDFull': '3128720/nick-chubb', 'fRefID': 'ChubNi00', 'weight': '227', 'jerseyNum': '24', 'cbsShortName': 'N. Chubb', 'team': 'CLE', 'yahooPlayerID': '31005', 'age': '28', 'espnLink': 'https://www.espn.com/nfl/player/_/id/3128720/nick-chubb', 'yahooLink': 'https://sports.yahoo.com/nfl/players/31005', 'bDay': '12/27/1995', 'espnHeadshot': 'https://a.espncdn.com/i/headshots/nfl/players/full/3128720.png', 'isFreeAgent': 'False', 'rotoWirePlayerIDFull': 'nick-chubb-12886', 'cbsLongName': 'Nick Chubb', 'injury': {'injReturnDate': '20250210', 'description': "Dec 16: Browns head coach Kevin Stefanski said Monday he doesn't expect Chubb to require surgery to address the broken left foot he suffered during Sunday's  21-7 loss to the Chiefs, Scott Petrak of the Elyria Chronicle-Telegram reports.", 'injDate': '20240805', 'designation': 'Out'}, 'teamID': '8', 'pos': 'RB', 'school': 'Georgia', 'cbsPlayerID': '2131579', 'longName': 'Nick Chubb', 'rotoWirePlayerID': '12886', 'height': '5\'11"', 'cbsPlayerIDFull': '2131579/nick-chubb', 'lastGamePlayed': '20241215_KC@CLE', 'playerID': '3128720', 'exp': '7', 'fantasyProsLink': 'https://www.fantasypros.com/nfl/players/nick-chubb.php', 'stats': {'Rushing': {'rushYds': '332.0', 'carries': '102.0', 'rushTD': '3.0'}, 'Receiving': {'receptions': '5.0', 'recTD': '1.0', 'targets': '11.0', 'recYds': '31.0'}, 'gamesPlayed': '8', 'Defense': {'totalTackles': '3.0', 'fumblesLost': '1.0', 'defTD': '0.0', 'fumbles': '1.0', 'fumblesRecovered': '0.0', 'soloTackles': '3.0', 'defensiveInterceptions': '0.0', 'qbHits': '0.0', 'tfl': '0.0', 'passDeflections': '0.0', 'sacks': '0.0'}, 'teamID': '8', 'team': 'CLE', 'teamAbv': 'CLE'}, 'projections': {}, 'games': {}}, 'Wide Receiver 1': {'espnID': '4262921', 'espnName': 'Justin Jefferson', 'sleeperBotID': '6794', 'fantasyProsPlayerID': '19236', 'espnIDFull': '4262921/justin-jefferson', 'fRefID': 'JeffJu00', 'weight': '195', 'jerseyNum': '18', 'team': 'MIN', 'yahooPlayerID': '32692', 'age': '25', 'espnLink': 'https://www.espn.com/nfl/player/_/id/4262921/justin-jefferson', 'yahooLink': 'https://sports.yahoo.com/nfl/players/32692', 'bDay': '6/16/1999', 'espnHeadshot': 'https://a.espncdn.com/i/headshots/nfl/players/full/4262921.png', 'isFreeAgent': 'False', 'rotoWirePlayerIDFull': 'justin-jefferson-14509', 'cbsLongName': 'Justin Jefferson', 'injury': {'injReturnDate': '', 'description': '', 'injDate': '', 'designation': ''}, 'teamID': '21', 'pos': 'WR', 'school': 'LSU', 'cbsPlayerID': '2871343', 'longName': 'Justin Jefferson', 'rotoWirePlayerID': '14509', 'height': '6\'1"', 'cbsPlayerIDFull': '2871343/justin-jefferson/', 'lastGamePlayed': '20241216_CHI@MIN', 'playerID': '4262921', 'exp': '5', 'fantasyProsLink': 'https://www.fantasypros.com/nfl/players/justin-jefferson.php', 'stats': {'Rushing': {'rushYds': '3.0', 'carries': '1.0', 'rushTD': '0.0'}, 'Passing': {'passAttempts': '1.0', 'passTD': '0.0', 'passYds': '22.0', 'int': '0.0', 'passCompletions': '1.0'}, 'Receiving': {'receptions': '82.0', 'recTD': '8.0', 'targets': '120.0', 'recYds': '1243.0'}, 'gamesPlayed': '14', 'Defense': {'totalTackles': '1.0', 'fumblesLost': '0.0', 'defTD': '0.0', 'fumbles': '1.0', 'fumblesRecovered': '0.0', 'soloTackles': '1.0', 'defensiveInterceptions': '0.0', 'qbHits': '0.0', 'tfl': '0.0', 'passDeflections': '0.0', 'sacks': '0.0'}, 'teamID': '21', 'team': 'MIN', 'teamAbv': 'MIN'}, 'projections': {'twoPointConversion': '0', 'Rushing': {'rushYds': '0.7', 'carries': '0.1', 'rushTD': '0'}, 'Passing': {'passAttempts': '0', 'passTD': '0', 'passYds': '0', 'int': '0', 'passCompletions': '0'}, 'Receiving': {'receptions': '6.1', 'recTD': '0.5', 'targets': '9.8', 'recYds': '83.3'}, 'fumblesLost': '0.1', 'pos': 'WR', 'teamID': '21', 'team': 'MIN', 'longName': 'Justin Jefferson', 'playerID': '4262921', 'fantasyPointsDefault': {'standard': '11.3', 'PPR': '17.4', 'halfPPR': '14.35'}}, 'games': {}}, 'Wide Receiver 2': {'espnID': '2977187', 'espnName': 'Cooper Kupp', 'sleeperBotID': '4039', 'fantasyProsPlayerID': '16433', 'espnIDFull': '2977187/cooper-kupp', 'fRefID': 'KuppCo00', 'weight': '207', 'jerseyNum': '10', 'cbsShortName': 'C. Kupp', 'team': 'LAR', 'yahooPlayerID': '30182', 'age': '31', 'espnLink': 'https://www.espn.com/nfl/player/_/id/2977187/cooper-kupp', 'yahooLink': 'https://sports.yahoo.com/nfl/players/30182', 'bDay': '6/15/1993', 'espnHeadshot': 'https://a.espncdn.com/i/headshots/nfl/players/full/2977187.png', 'isFreeAgent': 'False', 'rotoWirePlayerIDFull': 'cooper-kupp-11863', 'cbsLongName': 'Cooper Kupp', 'injury': {'injReturnDate': '', 'description': '', 'injDate': '', 'designation': ''}, 'teamID': '19', 'pos': 'WR', 'school': 'Eastern Washington', 'cbsPlayerID': '2006951', 'longName': 'Cooper Kupp', 'rotoWirePlayerID': '11863', 'height': '6\'2"', 'cbsPlayerIDFull': '2006951/cooper-kupp', 'lastGamePlayed': '20241212_LAR@SF', 'playerID': '2977187', 'exp': '8', 'fantasyProsLink': 'https://www.fantasypros.com/nfl/players/cooper-kupp.php', 'stats': {'Rushing': {'rushYds': '10.0', 'carries': '2.0', 'rushTD': '0.0'}, 'Receiving': {'receptions': '63.0', 'recTD': '6.0', 'targets': '94.0', 'recYds': '657.0'}, 'gamesPlayed': '10', 'Defense': {'totalTackles': '0.0', 'fumblesLost': '0.0', 'defTD': '0.0', 'fumbles': '1.0', 'fumblesRecovered': '1.0', 'soloTackles': '0.0', 'defensiveInterceptions': '0.0', 'qbHits': '0.0', 'tfl': '0.0', 'passDeflections': '0.0', 'sacks': '0.0'}, 'teamID': '19', 'team': 'LAR', 'teamAbv': 'LAR'}, 'projections': {'twoPointConversion': '0', 'Rushing': {'rushYds': '1.6', 'carries': '0.3', 'rushTD': '0'}, 'Passing': {'passAttempts': '0', 'passTD': '0', 'passYds': '0', 'int': '0', 'passCompletions': '0'}, 'Receiving': {'receptions': '5.6', 'recTD': '0.4', 'targets': '8.1', 'recYds': '66.5'}, 'fumblesLost': '0.1', 'pos': 'WR', 'teamID': '19', 'team': 'LAR', 'longName': 'Cooper Kupp', 'playerID': '2977187', 'fantasyPointsDefault': {'standard': '9.11', 'PPR': '14.71', 'halfPPR': '11.91'}}, 'games': {}}, 'Tight End': {'espnID': '15847', 'espnName': 'Travis Kelce', 'sleeperBotID': '1466', 'fantasyProsPlayerID': '11594', 'espnIDFull': '15847/travis-kelce', 'fRefID': 'KelcTr00', 'weight': '250', 'jerseyNum': '87', 'cbsShortName': 'T. Kelce', 'team': 'KC', 'yahooPlayerID': '26686', 'age': '35', 'espnLink': 'https://www.espn.com/nfl/player/_/id/15847/travis-kelce', 'yahooLink': 'https://sports.yahoo.com/nfl/players/26686', 'bDay': '10/5/1989', 'espnHeadshot': 'https://a.espncdn.com/i/headshots/nfl/players/full/15847.png', 'isFreeAgent': 'False', 'rotoWirePlayerIDFull': 'travis-kelce-8783', 'cbsLongName': 'Travis Kelce', 'injury': {'injReturnDate': '', 'description': '', 'injDate': '', 'designation': ''}, 'teamID': '16', 'pos': 'TE', 'school': 'Cincinnati', 'cbsPlayerID': '1725130', 'longName': 'Travis Kelce', 'rotoWirePlayerID': '8783', 'height': '6\'5"', 'cbsPlayerIDFull': '1725130/travis-kelce', 'lastGamePlayed': '20241215_KC@CLE', 'playerID': '15847', 'exp': '12', 'fantasyProsLink': 'https://www.fantasypros.com/nfl/players/travis-kelce.php', 'stats': {'Rushing': {'rushYds': '1.0', 'carries': '1.0', 'rushTD': '0.0'}, 'Receiving': {'receptions': '84.0', 'recTD': '2.0', 'targets': '115.0', 'recYds': '709.0'}, 'gamesPlayed': '14', 'Defense': {'totalTackles': '1.0', 'fumblesLost': '1.0', 'defTD': '0.0', 'fumbles': '2.0', 'fumblesRecovered': '0.0', 'soloTackles': '1.0', 'defensiveInterceptions': '0.0', 'qbHits': '0.0', 'tfl': '0.0', 'passDeflections': '0.0', 'sacks': '0.0'}, 'teamID': '16', 'team': 'KC', 'teamAbv': 'KC'}, 'projections': {'twoPointConversion': '0', 'Rushing': {'rushYds': '0.3', 'carries': '0.1', 'rushTD': '0'}, 'Passing': {'passAttempts': '0', 'passTD': '0', 'passYds': '0', 'int': '0', 'passCompletions': '0'}, 'Receiving': {'receptions': '5.7', 'recTD': '0.5', 'targets': '7.6', 'recYds': '60.6'}, 'fumblesLost': '0.1', 'pos': 'TE', 'teamID': '16', 'team': 'KC', 'longName': 'Travis Kelce', 'playerID': '15847', 'fantasyPointsDefault': {'standard': '8.99', 'PPR': '14.69', 'halfPPR': '11.84'}}, 'games': {}}, 'Flex': {'espnID': '3068267', 'espnName': 'Austin Ekeler', 'sleeperBotID': '4663', 'fantasyProsPlayerID': '16483', 'espnIDFull': '3068267/austin-ekeler', 'fRefID': 'EkelAu00', 'weight': '200', 'jerseyNum': '30', 'cbsShortName': 'A. Ekeler', 'team': 'WSH', 'yahooPlayerID': '30423', 'age': '29', 'espnLink': 'https://www.espn.com/nfl/player/_/id/3068267/austin-ekeler', 'yahooLink': 'https://sports.yahoo.com/nfl/players/30423', 'bDay': '5/17/1995', 'espnHeadshot': 'https://a.espncdn.com/i/headshots/nfl/players/full/3068267.png', 'isFreeAgent': 'False', 'rotoWirePlayerIDFull': 'austin-ekeler-12401', 'cbsLongName': 'Austin Ekeler', 'injury': {'injReturnDate': '20250105', 'description': "Dec 3: Ekeler said Tuesday that he's still dealing with concussion symptoms and neck pain, and he remains in the league's concussion protocol, Ben Standig of The Athletic reports.", 'injDate': '', 'designation': 'Injured Reserve'}, 'teamID': '32', 'pos': 'RB', 'school': 'Western Colorado', 'cbsPlayerID': '2820090', 'longName': 'Austin Ekeler', 'rotoWirePlayerID': '12401', 'height': '5\'9"', 'cbsPlayerIDFull': '2820090/austin-ekeler', 'lastGamePlayed': '20241124_DAL@WSH', 'playerID': '3068267', 'exp': '8', 'fantasyProsLink': 'https://www.fantasypros.com/nfl/players/austin-ekeler.php', 'stats': {'Rushing': {'rushYds': '355.0', 'carries': '74.0', 'rushTD': '4.0'}, 'Receiving': {'receptions': '33.0', 'recTD': '0.0', 'targets': '39.0', 'recYds': '346.0'}, 'gamesPlayed': '11', 'Defense': {'totalTackles': '0.0', 'fumblesLost': '0.0', 'defTD': '0.0', 'fumbles': '3.0', 'fumblesRecovered': '0.0', 'soloTackles': '0.0', 'defensiveInterceptions': '0.0', 'qbHits': '0.0', 'tfl': '0.0', 'passDeflections': '0.0', 'sacks': '0.0'}, 'teamID': '32', 'team': 'WSH', 'teamAbv': 'WSH'}, 'projections': {'twoPointConversion': '0', 'Rushing': {'rushYds': '30.5', 'carries': '7.7', 'rushTD': '0.2'}, 'Passing': {'passAttempts': '0', 'passTD': '0', 'passYds': '0', 'int': '0', 'passCompletions': '0'}, 'Receiving': {'receptions': '2.9', 'recTD': '0.1', 'targets': '4', 'recYds': '21.7'}, 'fumblesLost': '0.1', 'pos': 'RB', 'teamID': '32', 'team': 'WSH', 'longName': 'Austin Ekeler', 'playerID': '3068267', 'fantasyPointsDefault': {'standard': '6.92', 'PPR': '9.82', 'halfPPR': '8.37'}}, 'games': {}}}

        times = []
        for position, data in fantasy_team.items():
            start = time()
            print(data.get("playerID"))
            games = fetch_player_games(data.get("playerID"))
            parsed_games = []

            for game_id, data in games.items():
                try:
                    year = game_id[0:4]
                    month = game_id[4:6]
                    day = game_id[6:8]
                    game_date = datetime.date(*map(int, [year, month, day]))

                    parsed_games.append((game_date, data))
                except Exception as e:
                    raise Exception(f"Invalid game id: {e}")
                
            fantasy_team[position]['games'] = sorted(parsed_games, key=lambda x: x[0])
            times.append(time() - start)

        print(times)
        print(sum(times) / len(times))

        # Pass team data to the display template
        return render_template("team.html", team=fantasy_team)
    except Exception as err:
        print('OOPS', err)
        return render_template("hello.html")
    
# @team_routes.route("/api/ff/player/<id>", methods=["GET"])
# def ff_player(id):
#     projections = fetch_player_ff(id)
#     return json.dumps(projections)